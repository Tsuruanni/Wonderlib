          "content": "import 'package:flutter/material.dart';\nimport 'package:flutter_riverpod/flutter_riverpod.dart';\nimport 'package:go_router/go_router.dart';\n\nimport '../../../core/supabase_client.dart';\nimport 'user_list_screen.dart';\n\n/// Provider for loading a single user\nfinal userDetailProvider =\n    FutureProvider.family<Map<String, dynamic>?, String>((ref, userId) async {\n  final supabase = ref.watch(supabaseClientProvider);\n  final response = await supabase\n      .from('profiles')\n      .select('*, schools(id, name)')\n      .eq('id', userId)\n      .maybeSingle();\n\n  return response;\n});\n\nclass UserEditScreen extends ConsumerStatefulWidget {\n  const UserEditScreen({super.key, required this.userId});\n\n  final String userId;\n\n  @override\n  ConsumerState<UserEditScreen> createState() => _UserEditScreenState();\n}\n\nclass _UserEditScreenState extends ConsumerState<UserEditScreen> {\n  final _formKey = GlobalKey<FormState>();\n  final _firstNameController = TextEditingController();\n  final _lastNameController = TextEditingController();\n  final _emailController = TextEditingController();\n  final _studentNumberController = TextEditingController();\n\n  static const _validRoles = ['student', 'teacher', 'head', 'admin'];\n\n  String _role = 'student';\n  String? _schoolId;\n  bool _isLoading = true;\n  bool _isSaving = false;\n\n  @override\n  void initState() {\n    super.initState();\n    _loadUser();\n  }\n\n  Future<void> _loadUser() async {\n    setState(() => _isLoading = true);\n\n    final user = await ref.read(userDetailProvider(widget.userId).future);\n    if (user != null && mounted) {\n      _firstNameController.text = user['first_name'] ?? '';\n      _lastNameController.text = user['last_name'] ?? '';\n      _emailController.text = user['email'] ?? '';\n      _studentNumberController.text = user['student_number'] ?? '';\n      final dbRole = user['role'] as String? ?? 'student';\n      setState(() {\n        _role = _validRoles.contains(dbRole) ? dbRole : 'student';\n        _schoolId = user['school_id'] as String?;\n        _isLoading = false;\n      });\n    } else {\n      setState(() => _isLoading = false);\n    }\n  }\n\n  @override\n  void dispose() {\n    _firstNameController.dispose();\n    _lastNameController.dispose();\n    _emailController.dispose();\n    _studentNumberController.dispose();\n    super.dispose();\n  }\n\n  Future<void> _handleSave() async {\n    if (!_formKey.currentState!.validate()) return;\n\n    setState(() => _isSaving = true);\n\n    try {\n      final supabase = ref.read(supabaseClientProvider);\n\n      final data = {\n        'first_name': _firstNameController.text.trim(),\n        'last_name': _lastNameController.text.trim(),\n        'role': _role,\n        'school_id': _schoolId,\n        'student_number': _studentNumberController.text.trim().isEmpty\n            ? null\n            : _studentNumberController.text.trim(),\n      };\n\n      await supabase.from('profiles').update(data).eq('id', widget.userId);\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('User saved successfully')),\n        );\n        ref.invalidate(userDetailProvider(widget.userId));\n        ref.invalidate(usersProvider);\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(\n            content: Text('Error: $e'),\n            backgroundColor: Colors.red,\n          ),\n        );\n      }\n    } finally {\n      if (mounted) {\n        setState(() => _isSaving = false);\n      }\n    }\n  }\n\n  Future<void> _handleResetProgress() async {\n    final confirmed = await showDialog<bool>(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: const Text('Reset Progress'),\n        content: const Text(\n          'Are you sure you want to reset this user\\'s XP and level to 0? '\n          'This action cannot be undone.',\n        ),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context, false),\n            child: const Text('Cancel'),\n          ),\n          FilledButton(\n            onPressed: () => Navigator.pop(context, true),\n            style: FilledButton.styleFrom(backgroundColor: Colors.orange),\n            child: const Text('Reset'),\n          ),\n        ],\n      ),\n    );\n\n    if (confirmed != true) return;\n\n    try {\n      final supabase = ref.read(supabaseClientProvider);\n      await supabase.from('profiles').update({\n        'xp': 0,\n        'level': 1,\n        'current_streak': 0,\n      }).eq('id', widget.userId);\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Progress reset successfully')),\n        );\n        ref.invalidate(userDetailProvider(widget.userId));\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error: $e'), backgroundColor: Colors.red),\n        );\n      }\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final schoolsAsync = ref.watch(allSchoolsProvider);\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Edit User'),\n        leading: IconButton(\n          icon: const Icon(Icons.arrow_back),\n          onPressed: () => context.go('/users'),\n        ),\n        actions: [\n          const SizedBox(width: 8),\n          FilledButton(\n            onPressed: _isSaving ? null : _handleSave,\n            child: _isSaving\n                ? const SizedBox(\n                    width: 16,\n                    height: 16,\n                    child: CircularProgressIndicator(\n                      strokeWidth: 2,\n                      color: Colors.white,\n                    ),\n                  )\n                : const Text('Save'),\n          ),\n          const SizedBox(width: 16),\n        ],\n      ),\n      body: _isLoading\n          ? const Center(child: CircularProgressIndicator())\n          : SingleChildScrollView(\n              padding: const EdgeInsets.all(24),\n              child: Form(\n                key: _formKey,\n                child: Column(\n                  crossAxisAlignment: CrossAxisAlignment.start,\n                  children: [\n                    // Info banner\n                    Container(\n                      padding: const EdgeInsets.all(12),\n                      decoration: BoxDecoration(\n                        color: Colors.blue.shade50,\n                        borderRadius: BorderRadius.circular(8),\n                        border: Border.all(color: Colors.blue.shade200),\n                      ),\n                      child: Row(\n                        children: [\n                          Icon(Icons.info_outline, color: Colors.blue.shade700),\n                          const SizedBox(width: 12),\n                          Expanded(\n                            child: Text(\n                              'New users are created via Supabase Dashboard. '\n                              'This screen is for editing existing users only.',\n                              style: TextStyle(color: Colors.blue.shade700),\n                            ),\n                          ),\n                        ],\n                      ),\n                    ),\n                    const SizedBox(height: 24),\n\n                    Text(\n                      'User Details',\n                      style: Theme.of(context).textTheme.titleLarge,\n                    ),\n                    const SizedBox(height: 24),\n\n                    // Email (read-only)\n                    TextFormField(\n                      controller: _emailController,\n                      decoration: const InputDecoration(\n                        labelText: 'Email',\n                        helperText: 'Email cannot be changed',\n                      ),\n                      readOnly: true,\n                      enabled: false,\n                    ),\n                    const SizedBox(height: 16),\n\n                    // First name\n                    TextFormField(\n                      controller: _firstNameController,\n                      decoration: const InputDecoration(\n                        labelText: 'First Name',\n                        hintText: 'Enter first name',\n                      ),\n                      validator: (value) {\n                        if (value == null || value.trim().isEmpty) {\n                          return 'First name is required';\n                        }\n                        return null;\n                      },\n                    ),\n                    const SizedBox(height: 16),\n\n                    // Last name\n                    TextFormField(\n                      controller: _lastNameController,\n                      decoration: const InputDecoration(\n                        labelText: 'Last Name',\n                        hintText: 'Enter last name',\n                      ),\n                      validator: (value) {\n                        if (value == null || value.trim().isEmpty) {\n                          return 'Last name is required';\n                        }\n                        return null;\n                      },\n                    ),\n                    const SizedBox(height: 16),\n\n                    // Role dropdown\n                    DropdownButtonFormField<String>(\n                      value: _role,\n                      decoration: const InputDecoration(\n                        labelText: 'Role',\n                      ),\n                      items: _validRoles.map((role) {\n                        return DropdownMenuItem(\n                          value: role,\n                          child: Row(\n                            children: [\n                              Container(\n                                width: 12,\n                                height: 12,\n                                decoration: BoxDecoration(\n                                  color: _getRoleColor(role),\n                                  shape: BoxShape.circle,\n                                ),\n                              ),\n                              const SizedBox(width: 8),\n                              Text(_getRoleLabel(role)),\n                            ],\n                          ),\n                        );\n                      }).toList(),\n                      onChanged: (value) {\n                        if (value != null) {\n                          setState(() => _role = value);\n                        }\n                      },\n                    ),\n                    const SizedBox(height: 16),\n\n                    // School dropdown\n                    schoolsAsync.when(\n                      data: (schools) => DropdownButtonFormField<String?>(\n                        value: _schoolId,\n                        decoration: const InputDecoration(\n                          labelText: 'School',\n                          helperText: 'Required for students and teachers',\n                        ),\n                        items: [\n                          const DropdownMenuItem(\n                            value: null,\n                            child: Text('No School'),\n                          ),\n                          ...schools.map((school) => DropdownMenuItem(\n                                value: school['id'] as String,\n                                child: Text(school['name'] as String),\n                              )),\n                        ],\n                        onChanged: (value) {\n                          setState(() => _schoolId = value);\n                        },\n                        validator: (value) {\n                          if ((_role == 'student' || _role == 'teacher') &&\n                              value == null) {\n                            return 'School is required for students and teachers';\n                          }\n                          return null;\n                        },\n                      ),\n                      loading: () => const LinearProgressIndicator(),\n                      error: (_, __) => const Text('Error loading schools'),\n                    ),\n                    const SizedBox(height: 16),\n\n                    // Student number (only for students)\n                    if (_role == 'student')\n                      TextFormField(\n                        controller: _studentNumberController,\n                        decoration: const InputDecoration(\n                          labelText: 'Student Number',\n                          hintText: 'e.g., 2024001',\n                        ),\n                      ),\n                    const SizedBox(height: 32),\n\n                    // Danger zone\n                    Text(\n                      'Danger Zone',\n                      style: Theme.of(context).textTheme.titleMedium?.copyWith(\n                            color: Colors.red,\n                          ),\n                    ),\n                    const SizedBox(height: 12),\n                    OutlinedButton.icon(\n                      onPressed: _handleResetProgress,\n                      icon: const Icon(Icons.refresh),\n                      label: const Text('Reset XP & Progress'),\n                      style: OutlinedButton.styleFrom(\n                        foregroundColor: Colors.orange,\n                        side: const BorderSide(color: Colors.orange),\n                      ),\n                    ),\n                  ],\n                ),\n              ),\n            ),\n    );\n  }\n\n  Color _getRoleColor(String role) {\n    switch (role.toLowerCase()) {\n      case 'admin':\n        return Colors.red;\n      case 'head':\n        return Colors.purple;\n      case 'teacher':\n        return Colors.blue;\n      case 'student':\n        return Colors.green;\n      default:\n        return Colors.grey;\n    }\n  }\n\n  String _getRoleLabel(String role) {\n    switch (role.toLowerCase()) {\n      case 'admin':\n        return 'Admin';\n      case 'head':\n        return 'Head Teacher';\n      case 'teacher':\n        return 'Teacher';\n      case 'student':\n        return 'Student';\n      default:\n        return role;\n    }\n  }\n}\n"
        },
        "caller": {
          "type": "direct"
        }
      }
    ]
  },
  {
    "role": "user",
    "content": [
      {
        "tool_use_id": "toolu_01Y2orTK63avU9LaUwr6rDKm",
        "type": "tool_result",
        "content": "File created successfully at: /Users/wonderelt/Desktop/readeng_admin/lib/features/users/screens/user_edit_screen.dart"
      }
    ]
  },
  {
    "role": "assistant",
    "content": [
      {
        "type": "text",
        "text": "Şimdi Classes modülünü oluşturuyorum."
      }
    ]
  },
  {
    "role": "assistant",
    "content": [
      {
        "type": "tool_use",
        "id": "toolu_019pp4mBWdZhWZiiiu3jrmB2",
        "name": "Bash",
        "input": {
          "command": "mkdir -p /Users/wonderelt/Desktop/readeng_admin/lib/features/classes/screens",
          "description": "Create classes feature directory"
        },
        "caller": {
          "type": "direct"
        }
      }
    ]
  },
  {
    "role": "user",
    "content": [
      {
        "tool_use_id": "toolu_019pp4mBWdZhWZiiiu3jrmB2",
        "type": "tool_result",
        "content": "",
        "is_error": false
      }
    ]
  },
  {
    "role": "assistant",
    "content": [
      {
        "type": "tool_use",
        "id": "toolu_011Zwimm17JJxgWw2UqyuSsx",
        "name": "Write",
        "input": {
          "file_path": "/Users/wonderelt/Desktop/readeng_admin/lib/features/classes/screens/class_list_screen.dart",
