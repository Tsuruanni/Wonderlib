          "content": "import 'package:flutter/material.dart';\nimport 'package:flutter_riverpod/flutter_riverpod.dart';\nimport 'package:go_router/go_router.dart';\nimport 'package:uuid/uuid.dart';\n\nimport '../../../core/supabase_client.dart';\nimport 'badge_list_screen.dart';\n\n/// Provider for loading a single badge\nfinal badgeDetailProvider =\n    FutureProvider.family<Map<String, dynamic>?, String>((ref, badgeId) async {\n  final supabase = ref.watch(supabaseClientProvider);\n  final response = await supabase\n      .from('badges')\n      .select()\n      .eq('id', badgeId)\n      .maybeSingle();\n\n  return response;\n});\n\nclass BadgeEditScreen extends ConsumerStatefulWidget {\n  const BadgeEditScreen({super.key, this.badgeId});\n\n  final String? badgeId;\n\n  @override\n  ConsumerState<BadgeEditScreen> createState() => _BadgeEditScreenState();\n}\n\nclass _BadgeEditScreenState extends ConsumerState<BadgeEditScreen> {\n  final _formKey = GlobalKey<FormState>();\n  final _nameController = TextEditingController();\n  final _slugController = TextEditingController();\n  final _descriptionController = TextEditingController();\n  final _iconController = TextEditingController();\n  final _conditionValueController = TextEditingController();\n  final _xpRewardController = TextEditingController();\n\n  static const _conditionTypes = [\n    ('xp_total', 'Total XP Earned'),\n    ('streak_days', 'Consecutive Days Active'),\n    ('books_completed', 'Books Completed'),\n    ('vocabulary_learned', 'Words Learned'),\n    ('perfect_scores', 'Perfect Activity Scores'),\n  ];\n\n  static const _categories = ['achievement', 'streak', 'reading', 'vocabulary', 'special'];\n\n  String _conditionType = 'xp_total';\n  String _category = 'achievement';\n  bool _isLoading = false;\n  bool _isSaving = false;\n\n  bool get isNewBadge => widget.badgeId == null;\n\n  @override\n  void initState() {\n    super.initState();\n    if (!isNewBadge) {\n      _loadBadge();\n    } else {\n      _iconController.text = 'üèÜ';\n      _conditionValueController.text = '100';\n      _xpRewardController.text = '50';\n    }\n  }\n\n  Future<void> _loadBadge() async {\n    setState(() => _isLoading = true);\n\n    final badge = await ref.read(badgeDetailProvider(widget.badgeId!).future);\n    if (badge != null && mounted) {\n      _nameController.text = badge['name'] ?? '';\n      _slugController.text = badge['slug'] ?? '';\n      _descriptionController.text = badge['description'] ?? '';\n      _iconController.text = badge['icon'] ?? 'üèÜ';\n      _conditionValueController.text = (badge['condition_value'] ?? 100).toString();\n      _xpRewardController.text = (badge['xp_reward'] ?? 50).toString();\n      setState(() {\n        _conditionType = badge['condition_type'] ?? 'xp_total';\n        _category = badge['category'] ?? 'achievement';\n        _isLoading = false;\n      });\n    } else {\n      setState(() => _isLoading = false);\n    }\n  }\n\n  void _generateSlug() {\n    final slug = _nameController.text\n        .trim()\n        .toLowerCase()\n        .replaceAll(RegExp(r'[^a-z0-9\\s-]'), '')\n        .replaceAll(RegExp(r'\\s+'), '-');\n    _slugController.text = slug;\n  }\n\n  @override\n  void dispose() {\n    _nameController.dispose();\n    _slugController.dispose();\n    _descriptionController.dispose();\n    _iconController.dispose();\n    _conditionValueController.dispose();\n    _xpRewardController.dispose();\n    super.dispose();\n  }\n\n  Future<void> _handleSave() async {\n    if (!_formKey.currentState!.validate()) return;\n\n    setState(() => _isSaving = true);\n\n    try {\n      final supabase = ref.read(supabaseClientProvider);\n\n      final data = {\n        'name': _nameController.text.trim(),\n        'slug': _slugController.text.trim(),\n        'description': _descriptionController.text.trim(),\n        'icon': _iconController.text.trim(),\n        'category': _category,\n        'condition_type': _conditionType,\n        'condition_value': int.tryParse(_conditionValueController.text) ?? 100,\n        'xp_reward': int.tryParse(_xpRewardController.text) ?? 50,\n      };\n\n      if (isNewBadge) {\n        data['id'] = const Uuid().v4();\n        await supabase.from('badges').insert(data);\n\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(\n            const SnackBar(content: Text('Badge created successfully')),\n          );\n          ref.invalidate(badgesProvider);\n          context.go('/badges/${data['id']}');\n        }\n      } else {\n        await supabase.from('badges').update(data).eq('id', widget.badgeId!);\n\n        if (mounted) {\n          ScaffoldMessenger.of(context).showSnackBar(\n            const SnackBar(content: Text('Badge saved successfully')),\n          );\n          ref.invalidate(badgeDetailProvider(widget.badgeId!));\n          ref.invalidate(badgesProvider);\n        }\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(\n            content: Text('Error: $e'),\n            backgroundColor: Colors.red,\n          ),\n        );\n      }\n    } finally {\n      if (mounted) {\n        setState(() => _isSaving = false);\n      }\n    }\n  }\n\n  Future<void> _handleDelete() async {\n    final confirmed = await showDialog<bool>(\n      context: context,\n      builder: (context) => AlertDialog(\n        title: const Text('Delete Badge'),\n        content: const Text(\n          'Are you sure you want to delete this badge? '\n          'Users who earned this badge will keep their records. '\n          'This action cannot be undone.',\n        ),\n        actions: [\n          TextButton(\n            onPressed: () => Navigator.pop(context, false),\n            child: const Text('Cancel'),\n          ),\n          FilledButton(\n            onPressed: () => Navigator.pop(context, true),\n            style: FilledButton.styleFrom(backgroundColor: Colors.red),\n            child: const Text('Delete'),\n          ),\n        ],\n      ),\n    );\n\n    if (confirmed != true) return;\n\n    try {\n      final supabase = ref.read(supabaseClientProvider);\n      await supabase.from('badges').delete().eq('id', widget.badgeId!);\n\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Badge deleted')),\n        );\n        ref.invalidate(badgesProvider);\n        context.go('/badges');\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Error: $e'), backgroundColor: Colors.red),\n        );\n      }\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        title: Text(isNewBadge ? 'New Badge' : 'Edit Badge'),\n        leading: IconButton(\n          icon: const Icon(Icons.arrow_back),\n          onPressed: () => context.go('/badges'),\n        ),\n        actions: [\n          if (!isNewBadge)\n            IconButton(\n              icon: const Icon(Icons.delete_outline),\n              color: Colors.red,\n              onPressed: _handleDelete,\n            ),\n          const SizedBox(width: 8),\n          FilledButton(\n            onPressed: _isSaving ? null : _handleSave,\n            child: _isSaving\n                ? const SizedBox(\n                    width: 16,\n                    height: 16,\n                    child: CircularProgressIndicator(\n                      strokeWidth: 2,\n                      color: Colors.white,\n                    ),\n                  )\n                : Text(isNewBadge ? 'Create' : 'Save'),\n          ),\n          const SizedBox(width: 16),\n        ],\n      ),\n      body: _isLoading\n          ? const Center(child: CircularProgressIndicator())\n          : Row(\n              crossAxisAlignment: CrossAxisAlignment.start,\n              children: [\n                // Badge form\n                Expanded(\n                  flex: 2,\n                  child: SingleChildScrollView(\n                    padding: const EdgeInsets.all(24),\n                    child: Form(\n                      key: _formKey,\n                      child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                          Text(\n                            'Badge Details',\n                            style: Theme.of(context).textTheme.titleLarge,\n                          ),\n                          const SizedBox(height: 24),\n\n                          // Icon\n                          TextFormField(\n                            controller: _iconController,\n                            decoration: const InputDecoration(\n                              labelText: 'Icon (Emoji)',\n                              hintText: 'üèÜ',\n                              helperText: 'Enter an emoji to represent this badge',\n                            ),\n                            style: const TextStyle(fontSize: 24),\n                            validator: (value) {\n                              if (value == null || value.trim().isEmpty) {\n                                return 'Icon is required';\n                              }\n                              return null;\n                            },\n                          ),\n                          const SizedBox(height: 16),\n\n                          // Name\n                          TextFormField(\n                            controller: _nameController,\n                            decoration: const InputDecoration(\n                              labelText: 'Badge Name',\n                              hintText: 'e.g., First Steps',\n                            ),\n                            onChanged: (_) => _generateSlug(),\n                            validator: (value) {\n                              if (value == null || value.trim().isEmpty) {\n                                return 'Badge name is required';\n                              }\n                              return null;\n                            },\n                          ),\n                          const SizedBox(height: 16),\n\n                          // Slug\n                          TextFormField(\n                            controller: _slugController,\n                            decoration: const InputDecoration(\n                              labelText: 'Slug',\n                              hintText: 'first-steps',\n                              helperText: 'Auto-generated from name',\n                            ),\n                            validator: (value) {\n                              if (value == null || value.trim().isEmpty) {\n                                return 'Slug is required';\n                              }\n                              return null;\n                            },\n                          ),\n                          const SizedBox(height: 16),\n\n                          // Description\n                          TextFormField(\n                            controller: _descriptionController,\n                            decoration: const InputDecoration(\n                              labelText: 'Description',\n                              hintText: 'Describe what this badge represents',\n                            ),\n                            maxLines: 3,\n                          ),\n                          const SizedBox(height: 16),\n\n                          // Category\n                          DropdownButtonFormField<String>(\n                            value: _category,\n                            decoration: const InputDecoration(\n                              labelText: 'Category',\n                            ),\n                            items: _categories.map((cat) {\n                              return DropdownMenuItem(\n                                value: cat,\n                                child: Text(cat[0].toUpperCase() + cat.substring(1)),\n                              );\n                            }).toList(),\n                            onChanged: (value) {\n                              if (value != null) {\n                                setState(() => _category = value);\n                              }\n                            },\n                          ),\n                          const SizedBox(height: 24),\n\n                          Text(\n                            'Unlock Condition',\n                            style: Theme.of(context).textTheme.titleLarge,\n                          ),\n                          const SizedBox(height: 16),\n\n                          // Condition type\n                          DropdownButtonFormField<String>(\n                            value: _conditionType,\n                            decoration: const InputDecoration(\n                              labelText: 'Condition Type',\n                            ),\n                            items: _conditionTypes.map((type) {\n                              return DropdownMenuItem(\n                                value: type.$1,\n                                child: Text(type.$2),\n                              );\n                            }).toList(),\n                            onChanged: (value) {\n                              if (value != null) {\n                                setState(() => _conditionType = value);\n                              }\n                            },\n                          ),\n                          const SizedBox(height: 16),\n\n                          // Condition value\n                          TextFormField(\n                            controller: _conditionValueController,\n                            decoration: InputDecoration(\n                              labelText: 'Condition Value',\n                              hintText: 'e.g., 100',\n                              helperText: _getConditionHelper(_conditionType),\n                            ),\n                            keyboardType: TextInputType.number,\n                            validator: (value) {\n                              if (value == null || value.trim().isEmpty) {\n                                return 'Condition value is required';\n                              }\n                              if (int.tryParse(value) == null) {\n                                return 'Must be a number';\n                              }\n                              return null;\n                            },\n                          ),\n                          const SizedBox(height: 24),\n\n                          Text(\n                            'Reward',\n                            style: Theme.of(context).textTheme.titleLarge,\n                          ),\n                          const SizedBox(height: 16),\n\n                          // XP reward\n                          TextFormField(\n                            controller: _xpRewardController,\n                            decoration: const InputDecoration(\n                              labelText: 'XP Reward',\n                              hintText: 'e.g., 50',\n                              helperText: 'XP awarded when badge is earned',\n                            ),\n                            keyboardType: TextInputType.number,\n                            validator: (value) {\n                              if (value == null || value.trim().isEmpty) {\n                                return 'XP reward is required';\n                              }\n                              if (int.tryParse(value) == null) {\n                                return 'Must be a number';\n                              }\n                              return null;\n                            },\n                          ),\n                        ],\n                      ),\n                    ),\n                  ),\n                ),\n\n                // Preview\n                Expanded(\n                  flex: 1,\n                  child: Container(\n                    decoration: BoxDecoration(\n                      color: Colors.grey.shade50,\n                      border: Border(\n                        left: BorderSide(color: Colors.grey.shade200),\n                      ),\n                    ),\n                    padding: const EdgeInsets.all(24),\n                    child: Column(\n                      crossAxisAlignment: CrossAxisAlignment.start,\n                      children: [\n                        Text(\n                          'Preview',\n                          style: Theme.of(context).textTheme.titleMedium,\n                        ),\n                        const SizedBox(height: 16),\n                        Card(\n                          child: Padding(\n                            padding: const EdgeInsets.all(24),\n                            child: Column(\n                              children: [\n                                Container(\n                                  width: 80,\n                                  height: 80,\n                                  decoration: BoxDecoration(\n                                    color: Colors.amber.withValues(alpha: 0.1),\n                                    borderRadius: BorderRadius.circular(16),\n                                  ),\n                                  child: Center(\n                                    child: Text(\n                                      _iconController.text.isEmpty\n                                          ? 'üèÜ'\n                                          : _iconController.text,\n                                      style: const TextStyle(fontSize: 40),\n                                    ),\n                                  ),\n                                ),\n                                const SizedBox(height: 16),\n                                Text(\n                                  _nameController.text.isEmpty\n                                      ? 'Badge Name'\n                                      : _nameController.text,\n                                  style: const TextStyle(\n                                    fontSize: 18,\n                                    fontWeight: FontWeight.bold,\n                                  ),\n                                  textAlign: TextAlign.center,\n                                ),\n                                const SizedBox(height: 8),\n                                Text(\n                                  _descriptionController.text.isEmpty\n                                      ? 'Badge description'\n                                      : _descriptionController.text,\n                                  style: TextStyle(\n                                    fontSize: 14,\n                                    color: Colors.grey.shade600,\n                                  ),\n                                  textAlign: TextAlign.center,\n                                ),\n                                const SizedBox(height: 16),\n                                Container(\n                                  padding: const EdgeInsets.symmetric(\n                                    horizontal: 12,\n                                    vertical: 6,\n                                  ),\n                                  decoration: BoxDecoration(\n                                    color: Colors.purple.withValues(alpha: 0.1),\n                                    borderRadius: BorderRadius.circular(8),\n                                  ),\n                                  child: Text(\n                                    '+${_xpRewardController.text.isEmpty ? '50' : _xpRewardController.text} XP',\n                                    style: const TextStyle(\n                                      color: Colors.purple,\n                                      fontWeight: FontWeight.bold,\n                                    ),\n                                  ),\n                                ),\n                              ],\n                            ),\n                          ),\n                        ),\n                      ],\n                    ),\n                  ),\n                ),\n              ],\n            ),\n    );\n  }\n\n  String _getConditionHelper(String type) {\n    switch (type) {\n      case 'xp_total':\n        return 'Total XP user must earn';\n      case 'streak_days':\n        return 'Consecutive days of activity';\n      case 'books_completed':\n        return 'Number of books to complete';\n      case 'vocabulary_learned':\n        return 'Number of words to learn';\n      case 'perfect_scores':\n        return 'Perfect scores on activities';\n      default:\n        return '';\n    }\n  }\n}\n"
        },
        "caller": {
          "type": "direct"
        }
      }
    ]
  },
  {
    "role": "user",
    "content": [
      {
        "tool_use_id": "toolu_01DE6KgmZ6EGzHTn4jVxY7b4",
        "type": "tool_result",
        "content": "File created successfully at: /Users/wonderelt/Desktop/readeng_admin/lib/features/badges/screens/badge_edit_screen.dart"
      }
    ]
  },
  {
    "role": "assistant",
    "content": [
      {
        "type": "text",
        "text": "≈ûimdi Vocabulary mod√ºl√ºn√º olu≈üturuyorum."
      }
    ]
  },
  {
    "role": "assistant",
    "content": [
      {
        "type": "tool_use",
        "id": "toolu_01EYbMYgTej56AkXkQLbgLWX",
        "name": "Write",
        "input": {
          "file_path": "/Users/wonderelt/Desktop/readeng_admin/lib/features/vocabulary/screens/vocabulary_list_screen.dart",
