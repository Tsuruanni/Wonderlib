          "old_string": "### 4. Flutter Widget Mimarisi\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                      ReaderScreen                           │\n│  ┌──────────────────────────────────────────────────────┐  │\n│  │              AudioPlayerControls                      │  │\n│  │  [Play/Pause] [Progress Bar] [00:45/03:20] [1.0x]    │  │\n│  └──────────────────────────────────────────────────────┘  │\n│                                                             │\n│  ┌──────────────────────────────────────────────────────┐  │\n│  │           IntegratedReaderContent                     │  │\n│  │  ┌────────────────────────────────────────────────┐  │  │\n│  │  │         SyncedParagraphWidget                  │  │  │\n│  │  │  Normal text [HIGHLIGHTED SENTENCE] more text  │  │  │\n│  │  └────────────────────────────────────────────────┘  │  │\n│  │  ┌────────────────────────────────────────────────┐  │  │\n│  │  │         InlineActivityWidget                   │  │  │\n│  │  └────────────────────────────────────────────────┘  │  │\n│  └──────────────────────────────────────────────────────┘  │\n└─────────────────────────────────────────────────────────────┘\n```",
          "new_string": "### 4. Flutter Widget Mimarisi\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                      ReaderScreen                           │\n│  ┌──────────────────────────────────────────────────────┐  │\n│  │              AudioPlayerControls (Floating)           │  │\n│  │  [◀◀] [▶/⏸] [▶▶] ━━━━●━━━━━━━ 01:23/05:45  [1.0x]   │  │\n│  └──────────────────────────────────────────────────────┘  │\n│                                                             │\n│  ┌──────────────────────────────────────────────────────┐  │\n│  │           ContentBlockList (yeni widget)              │  │\n│  │  ┌────────────────────────────────────────────────┐  │  │\n│  │  │  TextBlockWidget (type: text)                  │  │  │\n│  │  │  \"Once upon a [TIME] there lived...\"           │  │  │\n│  │  │                   ↑                            │  │  │\n│  │  │           [HIGHLIGHTED WORD]                   │  │  │\n│  │  └────────────────────────────────────────────────┘  │  │\n│  │  ┌────────────────────────────────────────────────┐  │  │\n│  │  │  ImageBlockWidget (type: image)                │  │  │\n│  │  │  [═══════════ IMAGE ═══════════]               │  │  │\n│  │  │  \"A castle on the hill\"                        │  │  │\n│  │  └────────────────────────────────────────────────┘  │  │\n│  │  ┌────────────────────────────────────────────────┐  │  │\n│  │  │  ActivityBlockWidget (type: activity)          │  │  │\n│  │  │  [True/False Question]                         │  │  │\n│  │  └────────────────────────────────────────────────┘  │  │\n│  └──────────────────────────────────────────────────────┘  │\n└─────────────────────────────────────────────────────────────┘\n```\n\n### Word-Level Highlight Widget\n\n```dart\nclass WordHighlightText extends StatelessWidget {\n  final String text;\n  final List<WordTiming> wordTimings;\n  final int? activeWordIndex;  // Provider'dan gelir\n  final ReaderSettings settings;\n\n  @override\n  Widget build(BuildContext context) {\n    return RichText(\n      text: TextSpan(\n        children: _buildWordSpans(),\n      ),\n    );\n  }\n\n  List<InlineSpan> _buildWordSpans() {\n    final spans = <InlineSpan>[];\n    int currentIndex = 0;\n\n    for (int i = 0; i < wordTimings.length; i++) {\n      final timing = wordTimings[i];\n\n      // Kelime öncesi boşluk/punctuation\n      if (timing.startIndex > currentIndex) {\n        spans.add(TextSpan(\n          text: text.substring(currentIndex, timing.startIndex),\n          style: _normalStyle,\n        ));\n      }\n\n      // Kelime (highlight edilmiş veya normal)\n      final isActive = i == activeWordIndex;\n      spans.add(TextSpan(\n        text: timing.word,\n        style: isActive ? _highlightStyle : _normalStyle,\n      ));\n\n      currentIndex = timing.endIndex;\n    }\n\n    // Kalan metin\n    if (currentIndex < text.length) {\n      spans.add(TextSpan(text: text.substring(currentIndex)));\n    }\n\n    return spans;\n  }\n\n  TextStyle get _highlightStyle => TextStyle(\n    backgroundColor: Colors.yellow.withOpacity(0.5),\n    fontWeight: FontWeight.bold,\n  );\n}\n```"
        },
        "caller": {
          "type": "direct"
        }
      }
    ]
  },
  {
    "role": "user",
    "content": [
      {
        "tool_use_id": "toolu_01QUAaXnuHwXfyTg6SZYoDCu",
        "type": "tool_result",
        "content": "The file /Users/wonderelt/.claude/plans/polymorphic-munching-ember.md has been updated successfully."
      }
    ]
  },
  {
    "role": "assistant",
    "content": [
      {
        "type": "thinking",
        "thinking": "Now let me update the implementation phases to reflect the combined Faz 1 + 2 approach and add the verification plan. I also need to list all files to create/modify.",
        "signature": "Es4CCkYICxgCKkA1DF8v3wrP+huid2YknoCXzcB7YFuS4/xc76fZJ7YI+IOwvo/p3gp8xmjVpztoVs4uJAvY+hhyXxrT+/Uph5twEgz2hFs/knnNjN9/tf0aDI5FyaRpjjiTvWP0NyIwNcT6zDWk+aNjs69GqqQG05ZIj1G5gs5HaFogx6j9jko5hr0bGfsoQj31mT3oqefqKrUB2WZ3hFL98vLVJ5IEW2MFBdaAZWQPwVoTiw4yBCVLOq6O1DNh8YgkPlbhpsZjU+qNtCLR2K6YVotDT5GpKvxVV037eyrfu/TI7yGKISXeesT0dM1FeHrlsBkQnVDqZAInHes0bo5Iw5kxi/qiaEDZxAkF5QqF9eENvzSrfHBIQH+Iq2MPA9x/t3kctkbVi/CEIOUHu1a+zbR9jIZv4MRJsxmK8GD8kVyO8Wb0IHWFCnd/HAk7DxgB"
      }
    ]
  },
  {
    "role": "assistant",
    "content": [
      {
        "type": "tool_use",
        "id": "toolu_018gcELwHzAVoosyGFgsy5mg",
        "name": "Edit",
        "input": {
          "replace_all": false,
          "file_path": "/Users/wonderelt/.claude/plans/polymorphic-munching-ember.md",
          "old_string": "## Uygulama Fazları\n\n### Faz 1: MVP (Temel Audio Playback + Paragraf Highlight)\n- [ ] `audio_sync_data` tablosu oluştur\n- [ ] `AudioSyncData` entity, model, repository\n- [ ] `GetAudioSyncDataUseCase`\n- [ ] `AudioSyncController` provider\n- [ ] `AudioPlayerControls` widget\n- [ ] Paragraf-seviye highlight\n- [ ] ReaderScreen entegrasyonu\n\n### Faz 2: Gelişmiş Highlight\n- [ ] Cümle-seviye highlight\n- [ ] Auto-scroll (highlight'ı takip et)\n- [ ] Tap-to-seek (cümleye tıkla, o noktaya git)\n- [ ] Playback speed kontrolü\n\n### Faz 3: Content Management\n- [ ] TTS Edge Function\n- [ ] Forced alignment entegrasyonu\n- [ ] Admin UI (audio yükleme/yönetim)\n\n### Faz 4: İleri Özellikler\n- [ ] Word-level highlight (K-2 için)\n- [ ] Offline caching\n- [ ] Analytics (dinleme istatistikleri)\n\n---\n\n## Açık Sorular\n\n1. **Audio Kaynağı**: Pre-recorded mu, TTS mi?\n2. **Highlight Granularity**: Kelime, cümle, veya paragraf seviyesi?\n3. **Content Block Yapısı**: Mevcut yapıyı koruyalım mı, restructure mı?\n4. **Öncelik**: MVP önce mi, full feature mi?\n\n---\n\n## Verification Plan\n\n1. `dart analyze lib/` → No errors\n2. Manual test: Chapter with audio → Play → Text highlights sync\n3. Test playback controls: play/pause, seek, speed\n4. Test auto-scroll behavior\n5. `flutter test` → All tests pass",
          "new_string": "## Uygulama Planı (Faz 1 + 2 Birleşik)\n\n### Adım 1: Database & Migration\n- [ ] `content_blocks` tablosu oluştur\n- [ ] Mevcut `chapters.content` → `content_blocks` migration scripti\n- [ ] `chapters.content` nullable yap (backward compat)\n\n**Dosyalar:**\n```\nsupabase/migrations/YYYYMMDD_content_blocks.sql\nsupabase/migrations/YYYYMMDD_migrate_content_to_blocks.sql\n```\n\n### Adım 2: Domain Layer\n- [ ] `ContentBlock` entity\n- [ ] `WordTiming` value object\n- [ ] `ContentBlockRepository` interface\n- [ ] `GetContentBlocksUseCase`\n- [ ] `UpdateContentBlockAudioUseCase`\n\n**Dosyalar:**\n```\nlib/domain/entities/content_block.dart\nlib/domain/entities/word_timing.dart\nlib/domain/repositories/content_block_repository.dart\nlib/domain/usecases/content/get_content_blocks_usecase.dart\nlib/domain/usecases/content/update_content_block_audio_usecase.dart\n```\n\n### Adım 3: Data Layer\n- [ ] `ContentBlockModel` (JSON serialization)\n- [ ] `WordTimingModel`\n- [ ] `SupabaseContentBlockRepository`\n\n**Dosyalar:**\n```\nlib/data/models/content/content_block_model.dart\nlib/data/models/content/word_timing_model.dart\nlib/data/repositories/supabase/supabase_content_block_repository.dart\n```\n\n### Adım 4: Presentation Layer - Providers\n- [ ] `contentBlocksProvider` (chapter için blokları getir)\n- [ ] `audioSyncProvider` (playback state + aktif kelime index)\n- [ ] `AudioSyncController` (play/pause/seek/speed)\n\n**Dosyalar:**\n```\nlib/presentation/providers/content_block_provider.dart\nlib/presentation/providers/audio_sync_provider.dart\n```\n\n### Adım 5: Presentation Layer - Widgets\n- [ ] `ContentBlockList` (blokları listele)\n- [ ] `TextBlockWidget` (metin + kelime highlight)\n- [ ] `ImageBlockWidget` (görsel + caption)\n- [ ] `ActivityBlockWidget` (inline aktivite wrapper)\n- [ ] `WordHighlightText` (karaoke tarzı highlight)\n- [ ] `AudioPlayerControls` (floating player)\n\n**Dosyalar:**\n```\nlib/presentation/widgets/reader/content_block_list.dart\nlib/presentation/widgets/reader/text_block_widget.dart\nlib/presentation/widgets/reader/image_block_widget.dart\nlib/presentation/widgets/reader/activity_block_widget.dart\nlib/presentation/widgets/reader/word_highlight_text.dart\nlib/presentation/widgets/reader/audio_player_controls.dart\n```\n\n### Adım 6: ReaderScreen Entegrasyonu\n- [ ] `IntegratedReaderContent` → `ContentBlockList` ile değiştir\n- [ ] `AudioPlayerControls` ekle (floating bottom)\n- [ ] Auto-scroll implementasyonu\n\n**Dosyalar (Modify):**\n```\nlib/presentation/screens/reader/reader_screen.dart\n```\n\n### Adım 7: Audio Generation Pipeline (Edge Function)\n- [ ] Fal AI TTS entegrasyonu\n- [ ] R2 upload helper\n- [ ] WhisperX forced alignment (external service)\n- [ ] `generate-audio-sync` Edge Function\n\n**Dosyalar:**\n```\nsupabase/functions/generate-audio-sync/index.ts\nlib/core/services/fal_ai_service.dart (optional - if calling from app)\n```\n\n---\n\n## Dosya Özeti\n\n### Yeni Dosyalar (17 dosya)\n\n| Katman | Dosya |\n|--------|-------|\n| DB | `supabase/migrations/YYYYMMDD_content_blocks.sql` |\n| DB | `supabase/migrations/YYYYMMDD_migrate_content.sql` |\n| Domain | `lib/domain/entities/content_block.dart` |\n| Domain | `lib/domain/entities/word_timing.dart` |\n| Domain | `lib/domain/repositories/content_block_repository.dart` |\n| Domain | `lib/domain/usecases/content/get_content_blocks_usecase.dart` |\n| Domain | `lib/domain/usecases/content/update_content_block_audio_usecase.dart` |\n| Data | `lib/data/models/content/content_block_model.dart` |\n| Data | `lib/data/models/content/word_timing_model.dart` |\n| Data | `lib/data/repositories/supabase/supabase_content_block_repository.dart` |\n| Provider | `lib/presentation/providers/content_block_provider.dart` |\n| Provider | `lib/presentation/providers/audio_sync_provider.dart` |\n| Widget | `lib/presentation/widgets/reader/content_block_list.dart` |\n| Widget | `lib/presentation/widgets/reader/text_block_widget.dart` |\n| Widget | `lib/presentation/widgets/reader/word_highlight_text.dart` |\n| Widget | `lib/presentation/widgets/reader/audio_player_controls.dart` |\n| Edge Fn | `supabase/functions/generate-audio-sync/index.ts` |\n\n### Değiştirilecek Dosyalar (4 dosya)\n\n| Dosya | Değişiklik |\n|-------|------------|\n| `lib/presentation/screens/reader/reader_screen.dart` | ContentBlockList + AudioPlayerControls |\n| `lib/presentation/providers/repository_providers.dart` | ContentBlockRepository provider ekle |\n| `lib/presentation/providers/usecase_providers.dart` | UseCase provider'lar ekle |\n| `lib/domain/entities/chapter.dart` | `content` → deprecated, `hasContentBlocks` getter |\n\n---\n\n## Verification Plan\n\n### 1. Statik Analiz\n```bash\ndart analyze lib/\n# Hata: 0\n```\n\n### 2. Migration Test\n```bash\nsupabase db reset\n# content_blocks tablosu oluşmalı\n# Mevcut chapter content migrate olmalı\n```\n\n### 3. Unit Tests\n```bash\nflutter test test/unit/domain/entities/content_block_test.dart\nflutter test test/unit/data/models/content_block_model_test.dart\n```\n\n### 4. Manual Test Senaryoları\n\n| Senaryo | Beklenen |\n|---------|----------|\n| Chapter aç (audio var) | AudioPlayerControls görünür |\n| Play'e bas | Audio çalar, kelimeler sırayla highlight |\n| Pause | Audio durur, highlight son kelimede kalır |\n| Speed 1.5x | Hızlı çalar, highlight senkron kalır |\n| Kelimeye tıkla | O noktaya seek eder |\n| Scroll down (audio çalarken) | Auto-scroll aktif kelimeye döner |\n| Chapter aç (audio yok) | AudioPlayerControls gizli |\n\n### 5. Edge Function Test\n```bash\ncurl -X POST \"https://xxx.supabase.co/functions/v1/generate-audio-sync\" \\\n  -H \"Authorization: Bearer xxx\" \\\n  -d '{\"blockId\": \"xxx\", \"text\": \"Hello world\", \"voice\": \"Vivian\"}'\n# audioUrl ve wordTimings dönmeli\n```\n\n---\n\n## Açık Kararlar (Sonradan)\n\n1. **Forced Alignment Servisi**: WhisperX self-hosted mi, API mı? (Replicate.com'da var)\n2. **Offline Cache**: Audio dosyaları local'e cache edilecek mi?\n3. **Admin UI**: TTS generate butonu nerede? (Teacher dashboard, ayrı admin panel?)\n4. **Türkçe TTS**: Fal AI Türkçe destekliyor mu? (Test edilmeli)"
        },
        "caller": {
          "type": "direct"
        }
      }
    ]
  },
  {
    "role": "user",
    "content": [
      {
        "tool_use_id": "toolu_018gcELwHzAVoosyGFgsy5mg",
        "type": "tool_result",
        "content": "The file /Users/wonderelt/.claude/plans/polymorphic-munching-ember.md has been updated successfully."
      }
    ]
  },
  {
    "role": "assistant",
    "content": [
      {
        "type": "thinking",
        "thinking": "Now let me read the full plan to make sure it's complete and coherent, then I can exit plan mode for approval.",
        "signature": "EpYCCkYICxgCKkBFDtS219EKLpx5xzjkPZ0NQNApQxqqFJAwqM9HiBSYuT0om5A3BwLRW8K9Di3KYl6y7H+Qnf8n8AFk6zPZ9FYkEgx887/oQMYCH8BfsX4aDPk6xp7i0XCvR2emuiIwtF/uqa7feK5Gp1918FSMEM5VzIvzGIxTfl6d6K2Khc9vXW52XCUTIScv685wG9joKn79rtAluMT0qp3nrzdSc523cJSXI3Q2OnDpxW8z4PB8OkSCPPAyD6rIIFVDL7zRrG8WoE89D/zj5Lc0CZkfEu2UkHxZFrVS9M/DIXY9SqNVhKhO5XfUQx0eU24BoGUXes7RQ4WV2A87IQoAxPBcUDej8+mY0MgvbTNxYOyCB2UYAQ=="
      }
    ]
  },
  {
    "role": "assistant",
    "content": [
      {
        "type": "text",
        "text": "Plan dosyasını son haliyle okuyup doğruluyorum."
      }
    ]
  },
  {
    "role": "assistant",
    "content": [
      {
        "type": "tool_use",
        "id": "toolu_01RgqQ9YULVAUHJo3UGh4Gj8",
        "name": "Read",
        "input": {
          "file_path": "/Users/wonderelt/.claude/plans/polymorphic-munching-ember.md"
        },
        "caller": {
          "type": "direct"
        }
      }
    ]
  },
  {
    "role": "user",
    "content": [
      {
        "tool_use_id": "toolu_01RgqQ9YULVAUHJo3UGh4Gj8",
        "type": "tool_result",
