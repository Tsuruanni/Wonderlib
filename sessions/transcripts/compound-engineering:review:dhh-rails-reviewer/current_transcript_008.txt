        "content": "     1→# Senkronize Sesli Okuma ve Highlight Sistemi\n     2→\n     3→## Özet\n     4→Reader ekranlarına paragraf bazlı sesli okuma ve **kelime-seviye metin senkronizasyonu** eklenmesi. Ses çalarken her kelime sırayla highlight edilecek (karaoke tarzı).\n     5→\n     6→## Kullanıcı Kararları\n     7→- **Audio Kaynağı**: ~~Fal AI~~ → **ElevenLabs TTS with-timestamps** (tek API, timestamp dahil)\n     8→- **Highlight Seviyesi**: Kelime seviyesi (karaoke)\n     9→- **Veri Yapısı**: ContentBlock entity oluşturulacak (restructure)\n    10→- **Scope**: Faz 1 + 2 birlikte (MVP + auto-scroll + word highlight)\n    11→- **Admin Panel**: Faz 1'e dahil, ayrı web app olarak\n    12→\n    13→---\n    14→\n    15→## Mevcut Durum Analizi\n    16→\n    17→### Reader Sistemi\n    18→- `ReaderScreen` → Ana container (Riverpod)\n    19→- `IntegratedReaderContent` → Aktivite-gated içerik orchestration\n    20→- `ParagraphWidget` → Vocabulary highlight desteği ile paragraf render\n    21→- Content: Plain text, `\\n\\n` ile paragraf ayrımı\n    22→- Vocabulary: `startIndex/endIndex` karakter pozisyonları ile highlight\n    23→\n    24→### Audio Altyapısı (HAZIR)\n    25→- `AudioService` → `just_audio` ile tam implementasyon\n    26→- `Chapter.audioUrl` → Mevcut ama UI'da kullanılmıyor\n    27→- Cloudflare R2 → Media storage hazır\n    28→\n    29→### Kritik Dosyalar\n    30→```\n    31→lib/presentation/screens/reader/reader_screen.dart          # Ana reader\n    32→lib/presentation/widgets/reader/paragraph_widget.dart       # Paragraf render\n    33→lib/presentation/widgets/reader/integrated_reader_content.dart  # İçerik orchestration\n    34→lib/presentation/providers/reader_provider.dart             # State management\n    35→lib/core/services/audio_service.dart                        # Audio playback\n    36→lib/domain/entities/chapter.dart                            # Chapter entity\n    37→```\n    38→\n    39→---\n    40→\n    41→## Önerilen Mimari\n    42→\n    43→### 1. Data Model: AudioSyncData (Yeni Entity)\n    44→\n    45→```dart\n    46→/// Senkronizasyon granülaritesi\n    47→enum SyncGranularity { paragraph, sentence, word }\n    48→\n    49→/// Chapter için audio timing verisi\n    50→class AudioSyncData {\n    51→  final String id;\n    52→  final String chapterId;\n    53→  final String audioUrl;\n    54→  final Duration duration;\n    55→  final SyncGranularity granularity;\n    56→  final List<AudioSegment> segments;\n    57→  final String? source; // 'manual', 'tts', 'forced_alignment'\n    58→}\n    59→\n    60→/// Zamanlı metin segmenti\n    61→class AudioSegment {\n    62→  final String text;\n    63→  final Duration startTime;\n    64→  final Duration endTime;\n    65→  final int startIndex;  // Content içindeki karakter pozisyonu\n    66→  final int endIndex;\n    67→  final int? paragraphIndex;\n    68→  final int? sentenceIndex;\n    69→}\n    70→```\n    71→\n    72→### 2. Database Schema\n    73→\n    74→```sql\n    75→CREATE TABLE audio_sync_data (\n    76→    id UUID PRIMARY KEY,\n    77→    chapter_id UUID REFERENCES chapters(id) ON DELETE CASCADE,\n    78→    audio_url VARCHAR(500) NOT NULL,\n    79→    duration_ms INTEGER NOT NULL,\n    80→    granularity VARCHAR(20) CHECK (granularity IN ('paragraph', 'sentence', 'word')),\n    81→    segments JSONB NOT NULL,  -- [{text, startMs, endMs, startIndex, endIndex, ...}]\n    82→    source VARCHAR(50),\n    83→    created_at TIMESTAMPTZ DEFAULT NOW()\n    84→);\n    85→```\n    86→\n    87→### 3. Timing Data Format (JSON)\n    88→\n    89→```json\n    90→{\n    91→  \"segments\": [\n    92→    {\n    93→      \"text\": \"Once upon a time, there lived a merchant.\",\n    94→      \"startMs\": 0,\n    95→      \"endMs\": 2500,\n    96→      \"startIndex\": 0,\n    97→      \"endIndex\": 42,\n    98→      \"paragraphIndex\": 0,\n    99→      \"sentenceIndex\": 0\n   100→    }\n   101→  ]\n   102→}\n   103→```\n   104→\n   105→### 4. Flutter Widget Mimarisi\n   106→\n   107→```\n   108→┌─────────────────────────────────────────────────────────────┐\n   109→│                      ReaderScreen                           │\n   110→│  ┌──────────────────────────────────────────────────────┐  │\n   111→│  │              AudioPlayerControls (Floating)           │  │\n   112→│  │  [◀◀] [▶/⏸] [▶▶] ━━━━●━━━━━━━ 01:23/05:45  [1.0x]   │  │\n   113→│  └──────────────────────────────────────────────────────┘  │\n   114→│                                                             │\n   115→│  ┌──────────────────────────────────────────────────────┐  │\n   116→│  │           ContentBlockList (yeni widget)              │  │\n   117→│  │  ┌────────────────────────────────────────────────┐  │  │\n   118→│  │  │  TextBlockWidget (type: text)                  │  │  │\n   119→│  │  │  \"Once upon a [TIME] there lived...\"           │  │  │\n   120→│  │  │                   ↑                            │  │  │\n   121→│  │  │           [HIGHLIGHTED WORD]                   │  │  │\n   122→│  │  └────────────────────────────────────────────────┘  │  │\n   123→│  │  ┌────────────────────────────────────────────────┐  │  │\n   124→│  │  │  ImageBlockWidget (type: image)                │  │  │\n   125→│  │  │  [═══════════ IMAGE ═══════════]               │  │  │\n   126→│  │  │  \"A castle on the hill\"                        │  │  │\n   127→│  │  └────────────────────────────────────────────────┘  │  │\n   128→│  │  ┌────────────────────────────────────────────────┐  │  │\n   129→│  │  │  ActivityBlockWidget (type: activity)          │  │  │\n   130→│  │  │  [True/False Question]                         │  │  │\n   131→│  │  └────────────────────────────────────────────────┘  │  │\n   132→│  └──────────────────────────────────────────────────────┘  │\n   133→└─────────────────────────────────────────────────────────────┘\n   134→```\n   135→\n   136→### Word-Level Highlight Widget\n   137→\n   138→```dart\n   139→class WordHighlightText extends StatelessWidget {\n   140→  final String text;\n   141→  final List<WordTiming> wordTimings;\n   142→  final int? activeWordIndex;  // Provider'dan gelir\n   143→  final ReaderSettings settings;\n   144→\n   145→  @override\n   146→  Widget build(BuildContext context) {\n   147→    return RichText(\n   148→      text: TextSpan(\n   149→        children: _buildWordSpans(),\n   150→      ),\n   151→    );\n   152→  }\n   153→\n   154→  List<InlineSpan> _buildWordSpans() {\n   155→    final spans = <InlineSpan>[];\n   156→    int currentIndex = 0;\n   157→\n   158→    for (int i = 0; i < wordTimings.length; i++) {\n   159→      final timing = wordTimings[i];\n   160→\n   161→      // Kelime öncesi boşluk/punctuation\n   162→      if (timing.startIndex > currentIndex) {\n   163→        spans.add(TextSpan(\n   164→          text: text.substring(currentIndex, timing.startIndex),\n   165→          style: _normalStyle,\n   166→        ));\n   167→      }\n   168→\n   169→      // Kelime (highlight edilmiş veya normal)\n   170→      final isActive = i == activeWordIndex;\n   171→      spans.add(TextSpan(\n   172→        text: timing.word,\n   173→        style: isActive ? _highlightStyle : _normalStyle,\n   174→      ));\n   175→\n   176→      currentIndex = timing.endIndex;\n   177→    }\n   178→\n   179→    // Kalan metin\n   180→    if (currentIndex < text.length) {\n   181→      spans.add(TextSpan(text: text.substring(currentIndex)));\n   182→    }\n   183→\n   184→    return spans;\n   185→  }\n   186→\n   187→  TextStyle get _highlightStyle => TextStyle(\n   188→    backgroundColor: Colors.yellow.withOpacity(0.5),\n   189→    fontWeight: FontWeight.bold,\n   190→  );\n   191→}\n   192→```\n   193→\n   194→### 5. Audio Sync Provider\n   195→\n   196→```dart\n   197→class AudioSyncController extends StateNotifier<AudioSyncState> {\n   198→  // Audio position stream dinle\n   199→  // Binary search ile aktif segment bul\n   200→  // State güncelle → UI highlight değişir\n   201→\n   202→  void _onPositionChanged(Duration position) {\n   203→    final activeIndex = _findActiveSegment(segments, position);\n   204→    state = state.copyWith(activeSegmentIndex: activeIndex);\n   205→  }\n   206→}\n   207→```\n   208→\n   209→---\n   210→\n   211→## ContentBlock Mimarisi (SEÇİLDİ)\n   212→\n   213→Mevcut `Chapter.content` (plain text) yapısından **explicit ContentBlock** yapısına geçiş.\n   214→\n   215→### Yeni Entity: ContentBlock\n   216→\n   217→```dart\n   218→enum ContentBlockType {\n   219→  text,      // Paragraf metni\n   220→  image,     // Görsel\n   221→  audio,     // Standalone ses (podcast tarzı)\n   222→  activity,  // Inline aktivite referansı\n   223→}\n   224→\n   225→class ContentBlock {\n   226→  final String id;\n   227→  final String chapterId;\n   228→  final int orderIndex;\n   229→  final ContentBlockType type;\n   230→\n   231→  // Text block için\n   232→  final String? text;\n   233→  final List<WordTiming>? wordTimings;  // Kelime-seviye sync\n   234→  final String? audioUrl;               // Bu blok için ses\n   235→\n   236→  // Image block için\n   237→  final String? imageUrl;\n   238→  final String? caption;\n   239→\n   240→  // Activity block için\n   241→  final String? activityId;\n   242→}\n   243→\n   244→class WordTiming {\n   245→  final String word;\n   246→  final int startIndex;      // Metin içi karakter pozisyonu\n   247→  final int endIndex;\n   248→  final int startMs;         // Audio başlangıç (milisaniye)\n   249→  final int endMs;           // Audio bitiş\n   250→}\n   251→```\n   252→\n   253→### Database Schema: content_blocks\n   254→\n   255→```sql\n   256→CREATE TABLE content_blocks (\n   257→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   258→    chapter_id UUID NOT NULL REFERENCES chapters(id) ON DELETE CASCADE,\n   259→    order_index INTEGER NOT NULL,\n   260→    type VARCHAR(20) NOT NULL CHECK (type IN ('text', 'image', 'audio', 'activity')),\n   261→\n   262→    -- Text block\n   263→    text TEXT,\n   264→    audio_url VARCHAR(500),\n   265→    word_timings JSONB,  -- [{word, startIndex, endIndex, startMs, endMs}]\n   266→\n   267→    -- Image block\n   268→    image_url VARCHAR(500),\n   269→    caption TEXT,\n   270→\n   271→    -- Activity block\n   272→    activity_id UUID REFERENCES inline_activities(id),\n   273→\n   274→    created_at TIMESTAMPTZ DEFAULT NOW(),\n   275→    updated_at TIMESTAMPTZ DEFAULT NOW(),\n   276→\n   277→    UNIQUE(chapter_id, order_index)\n   278→);\n   279→\n   280→CREATE INDEX idx_content_blocks_chapter ON content_blocks(chapter_id);\n   281→```\n   282→\n   283→### Migration Stratejisi\n   284→\n   285→```\n   286→Mevcut: chapters.content (plain text \"\\n\\n\" separated)\n   287→        ↓\n   288→Yeni:   content_blocks tablosu (her paragraf ayrı row)\n   289→```\n   290→\n   291→1. Mevcut chapter'ları parse et\n   292→2. Her paragraf için `content_blocks` row oluştur\n   293→3. `chapters.content` → deprecated (nullable yap)\n   294→4. Yeni content ekleme artık `content_blocks` üzerinden\n   295→\n   296→---\n   297→\n   298→## Audio Pipeline: ElevenLabs TTS with Timestamps (BASİTLEŞTİ!)\n   299→\n   300→### ElevenLabs Avantajları\n   301→- **Endpoint**: `POST /v1/text-to-speech/:voice_id/with-timestamps`\n   302→- **TEK API ÇAĞRISI** = Audio + Word Timings (ayrı alignment yok!)\n   303→- **150+ dil** (Türkçe dahil)\n   304→- **Karakter ve kelime seviyesi** timestamp\n   305→- **Karaoke, subtitle, lip-sync** için ideal\n   306→\n   307→### Basitleştirilmiş Pipeline\n   308→\n   309→```\n   310→┌─────────────┐     ┌─────────────────────┐     ┌─────────────────┐\n   311→│ ContentBlock│────▶│  ElevenLabs TTS     │────▶│  Audio File +   │\n   312→│   (text)    │     │  with-timestamps    │     │  Word Timings   │\n   313→└─────────────┘     └─────────────────────┘     └─────────────────┘\n   314→                            │\n   315→                            ▼\n   316→                    ┌─────────────────┐\n   317→                    │  R2 Upload +    │\n   318→                    │  DB Update      │\n   319→                    └─────────────────┘\n   320→```\n   321→\n   322→**Forced alignment'a gerek yok** - ElevenLabs direkt veriyor!\n   323→\n   324→### ElevenLabs Response Format\n   325→\n   326→```json\n   327→{\n   328→  \"audio_base64\": \"...\",\n   329→  \"alignment\": {\n   330→    \"characters\": [\"H\",\"e\",\"l\",\"l\",\"o\",\" \",\"w\",\"o\",\"r\",\"l\",\"d\"],\n   331→    \"character_start_times_seconds\": [0.0, 0.05, 0.1, ...],\n   332→    \"character_end_times_seconds\": [0.05, 0.1, 0.15, ...]\n   333→  }\n   334→}\n   335→```\n   336→\n   337→### Edge Function: generate-audio-sync (Basitleşti)\n   338→\n   339→```typescript\n   340→// supabase/functions/generate-audio-sync/index.ts\n   341→Deno.serve(async (req) => {\n   342→  const { blockId, text, voiceId } = await req.json();\n   343→\n   344→  // 1. ElevenLabs TTS with timestamps - TEK ÇAĞRI!\n   345→  const response = await fetch(\n   346→    `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/with-timestamps`,\n   347→    {\n   348→      method: 'POST',\n   349→      headers: {\n   350→        'xi-api-key': Deno.env.get('ELEVENLABS_API_KEY'),\n   351→        'Content-Type': 'application/json',\n   352→      },\n   353→      body: JSON.stringify({\n   354→        text,\n   355→        model_id: 'eleven_multilingual_v2',\n   356→        output_format: 'mp3_44100_128',\n   357→      }),\n   358→    }\n   359→  );\n   360→\n   361→  const { audio_base64, alignment } = await response.json();\n   362→\n   363→  // 2. Audio'yu R2'ye yükle\n   364→  const audioBuffer = Buffer.from(audio_base64, 'base64');\n   365→  const audioUrl = await uploadToR2(audioBuffer, `${blockId}.mp3`);\n   366→\n   367→  // 3. Character timestamps → Word timings dönüştür\n   368→  const wordTimings = convertToWordTimings(text, alignment);\n   369→\n   370→  // 4. Database güncelle\n   371→  await supabase.from('content_blocks').update({\n   372→    audio_url: audioUrl,\n   373→    word_timings: wordTimings,\n   374→  }).eq('id', blockId);\n   375→\n   376→  return Response.json({ success: true, audioUrl, wordTimings });\n   377→});\n   378→\n   379→// Helper: Karakter timestamp'lerini kelime timestamp'lerine dönüştür\n   380→function convertToWordTimings(text: string, alignment: any) {\n   381→  const words = text.split(/\\s+/);\n   382→  const timings = [];\n   383→  let charIndex = 0;\n   384→\n   385→  for (const word of words) {\n   386→    const startMs = Math.floor(alignment.character_start_times_seconds[charIndex] * 1000);\n   387→    const endCharIndex = charIndex + word.length - 1;\n   388→    const endMs = Math.floor(alignment.character_end_times_seconds[endCharIndex] * 1000);\n   389→\n   390→    timings.push({\n   391→      word,\n   392→      startIndex: text.indexOf(word, charIndex),\n   393→      endIndex: text.indexOf(word, charIndex) + word.length,\n   394→      startMs,\n   395→      endMs,\n   396→    });\n   397→\n   398→    charIndex = endCharIndex + 2; // +1 word, +1 space\n   399→  }\n   400→\n   401→  return timings;\n   402→}\n   403→```\n   404→\n   405→---\n   406→\n   407→## Uygulama Planı (Yeniden Yapılandırılmış)\n   408→\n   409→### FAZ 1A: Database & Backend Altyapısı\n   410→\n   411→**Adım 1.1: Database Schema**\n   412→- [ ] `content_blocks` tablosu oluştur\n   413→- [ ] Mevcut `chapters.content` → `content_blocks` migration scripti\n   414→- [ ] `chapters.content` nullable yap (backward compat)\n   415→\n   416→```\n   417→supabase/migrations/YYYYMMDD_content_blocks.sql\n   418→supabase/migrations/YYYYMMDD_migrate_content_to_blocks.sql\n   419→```\n   420→\n   421→**Adım 1.2: Edge Function - Audio Generation**\n   422→- [ ] ElevenLabs TTS with-timestamps entegrasyonu\n   423→- [ ] R2 upload helper\n   424→- [ ] Character → Word timing dönüşümü\n   425→- [ ] `generate-audio-sync` Edge Function\n   426→\n   427→```\n   428→supabase/functions/generate-audio-sync/index.ts\n   429→supabase/functions/_shared/elevenlabs.ts\n   430→supabase/functions/_shared/r2-upload.ts\n   431→```\n   432→\n   433→---\n   434→\n   435→### FAZ 1B: Admin Web App (Ayrı Proje)\n   436→\n   437→**Yeni Flutter Web projesi**: `readeng-admin/`\n   438→\n   439→**Adım 1.3: Admin Proje Kurulumu**\n   440→- [ ] Flutter web projesi oluştur\n   441→- [ ] Supabase client konfigürasyonu\n   442→- [ ] Auth (admin-only login)\n   443→- [ ] Temel routing\n   444→\n   445→**Adım 1.4: Kitap Yönetimi**\n   446→- [ ] Kitap listesi ekranı\n   447→- [ ] Kitap oluştur/düzenle formu\n   448→- [ ] Chapter listesi ve sıralama\n   449→- [ ] Chapter içerik editörü (rich text veya markdown)\n   450→\n   451→**Adım 1.5: ContentBlock Editörü**\n   452→- [ ] Block listesi (drag & drop sıralama)\n   453→- [ ] Text block editörü\n   454→- [ ] Image block upload\n   455→- [ ] Activity block oluşturma\n   456→\n   457→**Adım 1.6: Audio Generation UI**\n   458→- [ ] Voice seçimi (ElevenLabs voices)\n   459→- [ ] \"Generate Audio\" butonu per block\n   460→- [ ] Preview player\n   461→- [ ] Bulk generate (tüm chapter için)\n   462→- [ ] Progress indicator\n   463→\n   464→```\n   465→readeng-admin/\n   466→├── lib/\n   467→│   ├── main.dart\n   468→│   ├── core/\n   469→│   │   ├── supabase_client.dart\n   470→│   │   └── elevenlabs_service.dart\n   471→│   ├── features/\n   472→│   │   ├── auth/\n   473→│   │   ├── books/\n   474→│   │   │   ├── screens/\n   475→│   │   │   │   ├── book_list_screen.dart\n   476→│   │   │   │   ├── book_edit_screen.dart\n   477→│   │   │   │   └── chapter_edit_screen.dart\n   478→│   │   │   └── widgets/\n   479→│   │   │       ├── content_block_editor.dart\n   480→│   │   │       └── audio_generator_widget.dart\n   481→│   │   └── dashboard/\n   482→│   └── shared/\n   483→└── pubspec.yaml\n   484→```\n   485→\n   486→---\n   487→\n   488→### FAZ 2: Reader App Widget'ları (Ana App)\n   489→\n   490→**Adım 2.1: Domain Layer**\n   491→- [ ] `ContentBlock` entity\n   492→- [ ] `WordTiming` value object\n   493→- [ ] `ContentBlockRepository` interface\n   494→- [ ] `GetContentBlocksUseCase`\n   495→\n   496→```\n   497→lib/domain/entities/content_block.dart\n   498→lib/domain/entities/word_timing.dart\n   499→lib/domain/repositories/content_block_repository.dart\n   500→lib/domain/usecases/content/get_content_blocks_usecase.dart\n   501→```\n   502→\n   503→**Adım 2.2: Data Layer**\n   504→- [ ] `ContentBlockModel` (JSON serialization)\n   505→- [ ] `WordTimingModel`\n   506→- [ ] `SupabaseContentBlockRepository`\n   507→\n   508→```\n   509→lib/data/models/content/content_block_model.dart\n   510→lib/data/models/content/word_timing_model.dart\n   511→lib/data/repositories/supabase/supabase_content_block_repository.dart\n   512→```\n   513→\n   514→**Adım 2.3: Providers**\n   515→- [ ] `contentBlocksProvider`\n   516→- [ ] `audioSyncProvider` (playback state + aktif kelime)\n   517→- [ ] `AudioSyncController`\n   518→\n   519→```\n   520→lib/presentation/providers/content_block_provider.dart\n   521→lib/presentation/providers/audio_sync_provider.dart\n   522→```\n   523→\n   524→**Adım 2.4: Widgets**\n   525→- [ ] `ContentBlockList`\n   526→- [ ] `TextBlockWidget` + `WordHighlightText`\n   527→- [ ] `ImageBlockWidget`\n   528→- [ ] `ActivityBlockWidget`\n   529→- [ ] `AudioPlayerControls`\n   530→\n   531→```\n   532→lib/presentation/widgets/reader/content_block_list.dart\n   533→lib/presentation/widgets/reader/text_block_widget.dart\n   534→lib/presentation/widgets/reader/word_highlight_text.dart\n   535→lib/presentation/widgets/reader/image_block_widget.dart\n   536→lib/presentation/widgets/reader/activity_block_widget.dart\n   537→lib/presentation/widgets/reader/audio_player_controls.dart\n   538→```\n   539→\n   540→**Adım 2.5: ReaderScreen Entegrasyonu**\n   541→- [ ] `IntegratedReaderContent` → `ContentBlockList` geçişi\n   542→- [ ] `AudioPlayerControls` floating widget\n   543→- [ ] Auto-scroll (aktif kelimeyi takip)\n   544→\n   545→```\n   546→lib/presentation/screens/reader/reader_screen.dart (modify)\n   547→```\n   548→\n   549→---\n   550→\n   551→## Dosya Özeti\n   552→\n   553→### Ana App (wonderlib/) - 14 dosya\n   554→\n   555→| Katman | Dosya |\n   556→|--------|-------|\n   557→| Domain | `lib/domain/entities/content_block.dart` |\n   558→| Domain | `lib/domain/entities/word_timing.dart` |\n   559→| Domain | `lib/domain/repositories/content_block_repository.dart` |\n   560→| Domain | 