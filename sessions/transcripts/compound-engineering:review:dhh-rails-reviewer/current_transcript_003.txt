        "content": "     1→# Senkronize Sesli Okuma ve Highlight Sistemi\n     2→\n     3→## Özet\n     4→Reader ekranlarına paragraf bazlı sesli okuma ve **kelime-seviye metin senkronizasyonu** eklenmesi. Ses çalarken her kelime sırayla highlight edilecek (karaoke tarzı).\n     5→\n     6→## Kullanıcı Kararları\n     7→- **Audio Kaynağı**: Fal AI (Qwen-3 TTS) + Forced Alignment\n     8→- **Highlight Seviyesi**: Kelime seviyesi (karaoke)\n     9→- **Veri Yapısı**: ContentBlock entity oluşturulacak (restructure)\n    10→- **Scope**: Faz 1 + 2 birlikte (MVP + auto-scroll + word highlight)\n    11→\n    12→---\n    13→\n    14→## Mevcut Durum Analizi\n    15→\n    16→### Reader Sistemi\n    17→- `ReaderScreen` → Ana container (Riverpod)\n    18→- `IntegratedReaderContent` → Aktivite-gated içerik orchestration\n    19→- `ParagraphWidget` → Vocabulary highlight desteği ile paragraf render\n    20→- Content: Plain text, `\\n\\n` ile paragraf ayrımı\n    21→- Vocabulary: `startIndex/endIndex` karakter pozisyonları ile highlight\n    22→\n    23→### Audio Altyapısı (HAZIR)\n    24→- `AudioService` → `just_audio` ile tam implementasyon\n    25→- `Chapter.audioUrl` → Mevcut ama UI'da kullanılmıyor\n    26→- Cloudflare R2 → Media storage hazır\n    27→\n    28→### Kritik Dosyalar\n    29→```\n    30→lib/presentation/screens/reader/reader_screen.dart          # Ana reader\n    31→lib/presentation/widgets/reader/paragraph_widget.dart       # Paragraf render\n    32→lib/presentation/widgets/reader/integrated_reader_content.dart  # İçerik orchestration\n    33→lib/presentation/providers/reader_provider.dart             # State management\n    34→lib/core/services/audio_service.dart                        # Audio playback\n    35→lib/domain/entities/chapter.dart                            # Chapter entity\n    36→```\n    37→\n    38→---\n    39→\n    40→## Önerilen Mimari\n    41→\n    42→### 1. Data Model: AudioSyncData (Yeni Entity)\n    43→\n    44→```dart\n    45→/// Senkronizasyon granülaritesi\n    46→enum SyncGranularity { paragraph, sentence, word }\n    47→\n    48→/// Chapter için audio timing verisi\n    49→class AudioSyncData {\n    50→  final String id;\n    51→  final String chapterId;\n    52→  final String audioUrl;\n    53→  final Duration duration;\n    54→  final SyncGranularity granularity;\n    55→  final List<AudioSegment> segments;\n    56→  final String? source; // 'manual', 'tts', 'forced_alignment'\n    57→}\n    58→\n    59→/// Zamanlı metin segmenti\n    60→class AudioSegment {\n    61→  final String text;\n    62→  final Duration startTime;\n    63→  final Duration endTime;\n    64→  final int startIndex;  // Content içindeki karakter pozisyonu\n    65→  final int endIndex;\n    66→  final int? paragraphIndex;\n    67→  final int? sentenceIndex;\n    68→}\n    69→```\n    70→\n    71→### 2. Database Schema\n    72→\n    73→```sql\n    74→CREATE TABLE audio_sync_data (\n    75→    id UUID PRIMARY KEY,\n    76→    chapter_id UUID REFERENCES chapters(id) ON DELETE CASCADE,\n    77→    audio_url VARCHAR(500) NOT NULL,\n    78→    duration_ms INTEGER NOT NULL,\n    79→    granularity VARCHAR(20) CHECK (granularity IN ('paragraph', 'sentence', 'word')),\n    80→    segments JSONB NOT NULL,  -- [{text, startMs, endMs, startIndex, endIndex, ...}]\n    81→    source VARCHAR(50),\n    82→    created_at TIMESTAMPTZ DEFAULT NOW()\n    83→);\n    84→```\n    85→\n    86→### 3. Timing Data Format (JSON)\n    87→\n    88→```json\n    89→{\n    90→  \"segments\": [\n    91→    {\n    92→      \"text\": \"Once upon a time, there lived a merchant.\",\n    93→      \"startMs\": 0,\n    94→      \"endMs\": 2500,\n    95→      \"startIndex\": 0,\n    96→      \"endIndex\": 42,\n    97→      \"paragraphIndex\": 0,\n    98→      \"sentenceIndex\": 0\n    99→    }\n   100→  ]\n   101→}\n   102→```\n   103→\n   104→### 4. Flutter Widget Mimarisi\n   105→\n   106→```\n   107→┌─────────────────────────────────────────────────────────────┐\n   108→│                      ReaderScreen                           │\n   109→│  ┌──────────────────────────────────────────────────────┐  │\n   110→│  │              AudioPlayerControls (Floating)           │  │\n   111→│  │  [◀◀] [▶/⏸] [▶▶] ━━━━●━━━━━━━ 01:23/05:45  [1.0x]   │  │\n   112→│  └──────────────────────────────────────────────────────┘  │\n   113→│                                                             │\n   114→│  ┌──────────────────────────────────────────────────────┐  │\n   115→│  │           ContentBlockList (yeni widget)              │  │\n   116→│  │  ┌────────────────────────────────────────────────┐  │  │\n   117→│  │  │  TextBlockWidget (type: text)                  │  │  │\n   118→│  │  │  \"Once upon a [TIME] there lived...\"           │  │  │\n   119→│  │  │                   ↑                            │  │  │\n   120→│  │  │           [HIGHLIGHTED WORD]                   │  │  │\n   121→│  │  └────────────────────────────────────────────────┘  │  │\n   122→│  │  ┌────────────────────────────────────────────────┐  │  │\n   123→│  │  │  ImageBlockWidget (type: image)                │  │  │\n   124→│  │  │  [═══════════ IMAGE ═══════════]               │  │  │\n   125→│  │  │  \"A castle on the hill\"                        │  │  │\n   126→│  │  └────────────────────────────────────────────────┘  │  │\n   127→│  │  ┌────────────────────────────────────────────────┐  │  │\n   128→│  │  │  ActivityBlockWidget (type: activity)          │  │  │\n   129→│  │  │  [True/False Question]                         │  │  │\n   130→│  │  └────────────────────────────────────────────────┘  │  │\n   131→│  └──────────────────────────────────────────────────────┘  │\n   132→└─────────────────────────────────────────────────────────────┘\n   133→```\n   134→\n   135→### Word-Level Highlight Widget\n   136→\n   137→```dart\n   138→class WordHighlightText extends StatelessWidget {\n   139→  final String text;\n   140→  final List<WordTiming> wordTimings;\n   141→  final int? activeWordIndex;  // Provider'dan gelir\n   142→  final ReaderSettings settings;\n   143→\n   144→  @override\n   145→  Widget build(BuildContext context) {\n   146→    return RichText(\n   147→      text: TextSpan(\n   148→        children: _buildWordSpans(),\n   149→      ),\n   150→    );\n   151→  }\n   152→\n   153→  List<InlineSpan> _buildWordSpans() {\n   154→    final spans = <InlineSpan>[];\n   155→    int currentIndex = 0;\n   156→\n   157→    for (int i = 0; i < wordTimings.length; i++) {\n   158→      final timing = wordTimings[i];\n   159→\n   160→      // Kelime öncesi boşluk/punctuation\n   161→      if (timing.startIndex > currentIndex) {\n   162→        spans.add(TextSpan(\n   163→          text: text.substring(currentIndex, timing.startIndex),\n   164→          style: _normalStyle,\n   165→        ));\n   166→      }\n   167→\n   168→      // Kelime (highlight edilmiş veya normal)\n   169→      final isActive = i == activeWordIndex;\n   170→      spans.add(TextSpan(\n   171→        text: timing.word,\n   172→        style: isActive ? _highlightStyle : _normalStyle,\n   173→      ));\n   174→\n   175→      currentIndex = timing.endIndex;\n   176→    }\n   177→\n   178→    // Kalan metin\n   179→    if (currentIndex < text.length) {\n   180→      spans.add(TextSpan(text: text.substring(currentIndex)));\n   181→    }\n   182→\n   183→    return spans;\n   184→  }\n   185→\n   186→  TextStyle get _highlightStyle => TextStyle(\n   187→    backgroundColor: Colors.yellow.withOpacity(0.5),\n   188→    fontWeight: FontWeight.bold,\n   189→  );\n   190→}\n   191→```\n   192→\n   193→### 5. Audio Sync Provider\n   194→\n   195→```dart\n   196→class AudioSyncController extends StateNotifier<AudioSyncState> {\n   197→  // Audio position stream dinle\n   198→  // Binary search ile aktif segment bul\n   199→  // State güncelle → UI highlight değişir\n   200→\n   201→  void _onPositionChanged(Duration position) {\n   202→    final activeIndex = _findActiveSegment(segments, position);\n   203→    state = state.copyWith(activeSegmentIndex: activeIndex);\n   204→  }\n   205→}\n   206→```\n   207→\n   208→---\n   209→\n   210→## ContentBlock Mimarisi (SEÇİLDİ)\n   211→\n   212→Mevcut `Chapter.content` (plain text) yapısından **explicit ContentBlock** yapısına geçiş.\n   213→\n   214→### Yeni Entity: ContentBlock\n   215→\n   216→```dart\n   217→enum ContentBlockType {\n   218→  text,      // Paragraf metni\n   219→  image,     // Görsel\n   220→  audio,     // Standalone ses (podcast tarzı)\n   221→  activity,  // Inline aktivite referansı\n   222→}\n   223→\n   224→class ContentBlock {\n   225→  final String id;\n   226→  final String chapterId;\n   227→  final int orderIndex;\n   228→  final ContentBlockType type;\n   229→\n   230→  // Text block için\n   231→  final String? text;\n   232→  final List<WordTiming>? wordTimings;  // Kelime-seviye sync\n   233→  final String? audioUrl;               // Bu blok için ses\n   234→\n   235→  // Image block için\n   236→  final String? imageUrl;\n   237→  final String? caption;\n   238→\n   239→  // Activity block için\n   240→  final String? activityId;\n   241→}\n   242→\n   243→class WordTiming {\n   244→  final String word;\n   245→  final int startIndex;      // Metin içi karakter pozisyonu\n   246→  final int endIndex;\n   247→  final int startMs;         // Audio başlangıç (milisaniye)\n   248→  final int endMs;           // Audio bitiş\n   249→}\n   250→```\n   251→\n   252→### Database Schema: content_blocks\n   253→\n   254→```sql\n   255→CREATE TABLE content_blocks (\n   256→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   257→    chapter_id UUID NOT NULL REFERENCES chapters(id) ON DELETE CASCADE,\n   258→    order_index INTEGER NOT NULL,\n   259→    type VARCHAR(20) NOT NULL CHECK (type IN ('text', 'image', 'audio', 'activity')),\n   260→\n   261→    -- Text block\n   262→    text TEXT,\n   263→    audio_url VARCHAR(500),\n   264→    word_timings JSONB,  -- [{word, startIndex, endIndex, startMs, endMs}]\n   265→\n   266→    -- Image block\n   267→    image_url VARCHAR(500),\n   268→    caption TEXT,\n   269→\n   270→    -- Activity block\n   271→    activity_id UUID REFERENCES inline_activities(id),\n   272→\n   273→    created_at TIMESTAMPTZ DEFAULT NOW(),\n   274→    updated_at TIMESTAMPTZ DEFAULT NOW(),\n   275→\n   276→    UNIQUE(chapter_id, order_index)\n   277→);\n   278→\n   279→CREATE INDEX idx_content_blocks_chapter ON content_blocks(chapter_id);\n   280→```\n   281→\n   282→### Migration Stratejisi\n   283→\n   284→```\n   285→Mevcut: chapters.content (plain text \"\\n\\n\" separated)\n   286→        ↓\n   287→Yeni:   content_blocks tablosu (her paragraf ayrı row)\n   288→```\n   289→\n   290→1. Mevcut chapter'ları parse et\n   291→2. Her paragraf için `content_blocks` row oluştur\n   292→3. `chapters.content` → deprecated (nullable yap)\n   293→4. Yeni content ekleme artık `content_blocks` üzerinden\n   294→\n   295→---\n   296→\n   297→## Audio Pipeline: Fal AI + Forced Alignment\n   298→\n   299→### Fal AI Qwen-3 TTS Özellikleri\n   300→- **Endpoint**: `fal-ai/qwen-3-tts/text-to-speech/1.7b`\n   301→- **Voices**: Vivian, Serena, Dylan, Eric, Ryan, Aiden, vs.\n   302→- **Languages**: Auto, English, Turkish?, Chinese, Spanish, French...\n   303→- **Output**: MP3, 24kHz, mono\n   304→- **⚠️ SINIR**: Timestamp vermiyor, sadece toplam duration\n   305→\n   306→### Gerekli Pipeline\n   307→\n   308→```\n   309→┌─────────────┐     ┌─────────────┐     ┌─────────────────┐\n   310→│ ContentBlock│────▶│  Fal AI     │────▶│  Audio File     │\n   311→│   (text)    │     │  TTS API    │     │  (.mp3)         │\n   312→└─────────────┘     └─────────────┘     └─────────────────┘\n   313→       │                                        │\n   314→       │                                        ▼\n   315→       │            ┌─────────────────┐  ┌─────────────────┐\n   316→       └───────────▶│ Forced Aligner  │◀─│  Text + Audio   │\n   317→                    │ (WhisperX/Aeneas)│  │                 │\n   318→                    └─────────────────┘  └─────────────────┘\n   319→                            │\n   320→                            ▼\n   321→                    ┌─────────────────┐\n   322→                    │  Word Timings   │\n   323→                    │  (JSON)         │\n   324→                    └─────────────────┘\n   325→```\n   326→\n   327→### Forced Alignment Seçenekleri\n   328→\n   329→| Tool | Pros | Cons |\n   330→|------|------|------|\n   331→| **WhisperX** | En doğru, kelime-seviye, çok dilli | GPU gerektirir, yavaş |\n   332→| **Aeneas** | Hızlı, lightweight | Cümle-seviye (kelime için hack gerekir) |\n   333→| **Gentle** | Kelime-seviye, iyi doğruluk | Self-hosted, sadece İngilizce |\n   334→\n   335→**Önerilen**: WhisperX (Edge Function veya external service olarak)\n   336→\n   337→### Edge Function: generate-audio-sync\n   338→\n   339→```typescript\n   340→// supabase/functions/generate-audio-sync/index.ts\n   341→Deno.serve(async (req) => {\n   342→  const { blockId, text, voice } = await req.json();\n   343→\n   344→  // 1. Fal AI TTS çağır\n   345→  const audioResult = await fal.subscribe(\"fal-ai/qwen-3-tts/text-to-speech/1.7b\", {\n   346→    input: { text, voice }\n   347→  });\n   348→\n   349→  // 2. Audio'yu R2'ye yükle\n   350→  const audioUrl = await uploadToR2(audioResult.url, blockId);\n   351→\n   352→  // 3. WhisperX ile forced alignment (external API veya self-hosted)\n   353→  const wordTimings = await runForcedAlignment(text, audioUrl);\n   354→\n   355→  // 4. content_blocks tablosunu güncelle\n   356→  await supabase.from('content_blocks').update({\n   357→    audio_url: audioUrl,\n   358→    word_timings: wordTimings\n   359→  }).eq('id', blockId);\n   360→\n   361→  return Response.json({ success: true, audioUrl, wordTimings });\n   362→});\n   363→```\n   364→\n   365→---\n   366→\n   367→## Uygulama Planı (Faz 1 + 2 Birleşik)\n   368→\n   369→### Adım 1: Database & Migration\n   370→- [ ] `content_blocks` tablosu oluştur\n   371→- [ ] Mevcut `chapters.content` → `content_blocks` migration scripti\n   372→- [ ] `chapters.content` nullable yap (backward compat)\n   373→\n   374→**Dosyalar:**\n   375→```\n   376→supabase/migrations/YYYYMMDD_content_blocks.sql\n   377→supabase/migrations/YYYYMMDD_migrate_content_to_blocks.sql\n   378→```\n   379→\n   380→### Adım 2: Domain Layer\n   381→- [ ] `ContentBlock` entity\n   382→- [ ] `WordTiming` value object\n   383→- [ ] `ContentBlockRepository` interface\n   384→- [ ] `GetContentBlocksUseCase`\n   385→- [ ] `UpdateContentBlockAudioUseCase`\n   386→\n   387→**Dosyalar:**\n   388→```\n   389→lib/domain/entities/content_block.dart\n   390→lib/domain/entities/word_timing.dart\n   391→lib/domain/repositories/content_block_repository.dart\n   392→lib/domain/usecases/content/get_content_blocks_usecase.dart\n   393→lib/domain/usecases/content/update_content_block_audio_usecase.dart\n   394→```\n   395→\n   396→### Adım 3: Data Layer\n   397→- [ ] `ContentBlockModel` (JSON serialization)\n   398→- [ ] `WordTimingModel`\n   399→- [ ] `SupabaseContentBlockRepository`\n   400→\n   401→**Dosyalar:**\n   402→```\n   403→lib/data/models/content/content_block_model.dart\n   404→lib/data/models/content/word_timing_model.dart\n   405→lib/data/repositories/supabase/supabase_content_block_repository.dart\n   406→```\n   407→\n   408→### Adım 4: Presentation Layer - Providers\n   409→- [ ] `contentBlocksProvider` (chapter için blokları getir)\n   410→- [ ] `audioSyncProvider` (playback state + aktif kelime index)\n   411→- [ ] `AudioSyncController` (play/pause/seek/speed)\n   412→\n   413→**Dosyalar:**\n   414→```\n   415→lib/presentation/providers/content_block_provider.dart\n   416→lib/presentation/providers/audio_sync_provider.dart\n   417→```\n   418→\n   419→### Adım 5: Presentation Layer - Widgets\n   420→- [ ] `ContentBlockList` (blokları listele)\n   421→- [ ] `TextBlockWidget` (metin + kelime highlight)\n   422→- [ ] `ImageBlockWidget` (görsel + caption)\n   423→- [ ] `ActivityBlockWidget` (inline aktivite wrapper)\n   424→- [ ] `WordHighlightText` (karaoke tarzı highlight)\n   425→- [ ] `AudioPlayerControls` (floating player)\n   426→\n   427→**Dosyalar:**\n   428→```\n   429→lib/presentation/widgets/reader/content_block_list.dart\n   430→lib/presentation/widgets/reader/text_block_widget.dart\n   431→lib/presentation/widgets/reader/image_block_widget.dart\n   432→lib/presentation/widgets/reader/activity_block_widget.dart\n   433→lib/presentation/widgets/reader/word_highlight_text.dart\n   434→lib/presentation/widgets/reader/audio_player_controls.dart\n   435→```\n   436→\n   437→### Adım 6: ReaderScreen Entegrasyonu\n   438→- [ ] `IntegratedReaderContent` → `ContentBlockList` ile değiştir\n   439→- [ ] `AudioPlayerControls` ekle (floating bottom)\n   440→- [ ] Auto-scroll implementasyonu\n   441→\n   442→**Dosyalar (Modify):**\n   443→```\n   444→lib/presentation/screens/reader/reader_screen.dart\n   445→```\n   446→\n   447→### Adım 7: Audio Generation Pipeline (Edge Function)\n   448→- [ ] Fal AI TTS entegrasyonu\n   449→- [ ] R2 upload helper\n   450→- [ ] WhisperX forced alignment (external service)\n   451→- [ ] `generate-audio-sync` Edge Function\n   452→\n   453→**Dosyalar:**\n   454→```\n   455→supabase/functions/generate-audio-sync/index.ts\n   456→lib/core/services/fal_ai_service.dart (optional - if calling from app)\n   457→```\n   458→\n   459→---\n   460→\n   461→## Dosya Özeti\n   462→\n   463→### Yeni Dosyalar (17 dosya)\n   464→\n   465→| Katman | Dosya |\n   466→|--------|-------|\n   467→| DB | `supabase/migrations/YYYYMMDD_content_blocks.sql` |\n   468→| DB | `supabase/migrations/YYYYMMDD_migrate_content.sql` |\n   469→| Domain | `lib/domain/entities/content_block.dart` |\n   470→| Domain | `lib/domain/entities/word_timing.dart` |\n   471→| Domain | `lib/domain/repositories/content_block_repository.dart` |\n   472→| Domain | `lib/domain/usecases/content/get_content_blocks_usecase.dart` |\n   473→| Domain | `lib/domain/usecases/content/update_content_block_audio_usecase.dart` |\n   474→| Data | `lib/data/models/content/content_block_model.dart` |\n   475→| Data | `lib/data/models/content/word_timing_model.dart` |\n   476→| Data | `lib/data/repositories/supabase/supabase_content_block_repository.dart` |\n   477→| Provider | `lib/presentation/providers/content_block_provider.dart` |\n   478→| Provider | `lib/presentation/providers/audio_sync_provider.dart` |\n   479→| Widget | `lib/presentation/widgets/reader/content_block_list.dart` |\n   480→| Widget | `lib/presentation/widgets/reader/text_block_widget.dart` |\n   481→| Widget | `lib/presentation/widgets/reader/word_highlight_text.dart` |\n   482→| Widget | `lib/presentation/widgets/reader/audio_player_controls.dart` |\n   483→| Edge Fn | `supabase/functions/generate-audio-sync/index.ts` |\n   484→\n   485→### Değiştirilecek Dosyalar (4 dosya)\n   486→\n   487→| Dosya | Değişiklik |\n   488→|-------|------------|\n   489→| `lib/presentation/screens/reader/reader_screen.dart` | ContentBlockList + AudioPlayerControls |\n   490→| `lib/presentation/providers/repository_providers.dart` | ContentBlockRepository provider ekle |\n   491→| `lib/presentation/providers/usecase_providers.dart` | UseCase provider'lar ekle |\n   492→| `lib/domain/entities/chapter.dart` | `content` → deprecated, `hasContentBlocks` getter |\n   493→\n   494→---\n   495→\n   496→## Verification Plan\n   497→\n   498→### 1. Statik Analiz\n   499→```bash\n   500→dart analyze lib/\n   501→# Hata: 0\n   502→```\n   503→\n   504→### 2. Migration Test\n   505→```bash\n   506→supabase db reset\n   507→# content_blocks tablosu oluşmalı\n   508→# Mevcut chapter content migrate olmalı\n   509→```\n   510→\n   511→### 3. Unit Tests\n   512→```bash\n   513→flutter test test/unit/domain/entities/content_block_test.dart\n   514→flutter test test/unit/data/models/content_block_model_test.dart\n   515→```\n   516→\n   517→### 4. Manual Test Senaryoları\n   518→\n   519→| Senaryo | Beklenen |\n   520→|---------|----------|\n   521→| Chapter aç (audio var) | AudioPlayerControls görünür |\n   522→| Play'e bas | Audio çalar, kelimeler sırayla highlight |\n   523→| Pause | Audio durur, highlight son kelimede kalır |\n   524→| Speed 1.5x | Hızlı çalar, highlight senkron kalır |\n   525→| Kelimeye tıkla | O noktaya seek eder |\n   526→| Scroll down (audio çalarken) | Auto-scroll aktif kelimeye döner |\n   527→| Chapter aç (audio yok) | AudioPlayerControls gizli |\n   528→\n   529→### 5. Edge Function Test\n   